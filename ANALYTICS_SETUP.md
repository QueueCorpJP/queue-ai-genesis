# 🔧 Queue-LP 分析機能セットアップガイド

## 概要
Queue-LPに分析機能（Analytics）を追加するためのセットアップガイドです。
記事閲覧数の追跡、お問い合わせ件数の統計、管理者ダッシュボードでの分析表示が可能になります。

## 🔥 新機能

### 📊 分析ダッシュボード
- **各記事の閲覧数**: 記事別閲覧ランキング
- **今週のお問い合わせ件数**: 週単位の統計
- **今月のお問い合わせ件数**: 月単位の統計  
- **今月公開記事数**: 公開記事の統計
- **過去7日間の推移**: 日別お問い合わせ推移グラフ

### 🔐 セッション管理強化
- **24時間自動ログイン維持**: リロードしても認証状態が保持
- **30分無操作タイムアウト**: セキュリティ強化
- **アクティビティ監視**: ユーザー操作を自動検知
- **セッション自動更新**: 定期的なセッション確認

## 📋 セットアップ手順

### 1. データベースマイグレーション

Supabaseの管理画面にアクセスし、SQL Editorで以下のマイグレーションを実行してください：

```bash
# プロジェクトディレクトリに移動
cd queue-ai-genesis

# マイグレーションファイルの内容をSupabase SQL Editorで実行
# database_migration_analytics.sql
```

#### マイグレーション内容
- `news_article_views` テーブルの作成
- 閲覧数統計ビューの作成
- 便利な関数の作成
- 適切な権限設定

### 2. 環境変数の確認

`.env` ファイルまたは環境変数で以下が設定されていることを確認：

```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 3. 依存関係の確認

```bash
# 必要なパッケージがインストールされているか確認
npm list @supabase/supabase-js
npm list sonner
```

### 4. 開発サーバーの起動

```bash
npm run dev
```

## 🗃️ データベース構造

### 新しいテーブル

#### `news_article_views` - 記事閲覧数追跡
```sql
- id: UUID (主キー)
- article_id: UUID (記事ID)
- ip_address: TEXT (閲覧者IP)
- user_agent: TEXT (ブラウザ情報)
- created_at: TIMESTAMP (閲覧日時)
```

### 新しいビュー

#### `article_view_stats` - 記事統計
- 記事ごとの閲覧数
- ユニーク閲覧者数
- 最新閲覧日時

#### `daily_article_views` - 日別統計
- 日別閲覧数
- 日別ユニーク閲覧者数

### 新しい関数

```sql
-- 記事の総閲覧数を取得
SELECT get_article_view_count('記事UUID');

-- 記事のユニーク閲覧者数を取得
SELECT get_article_unique_viewers('記事UUID');

-- 期間別統計を取得
SELECT * FROM get_article_views_by_period('記事UUID', '2024-01-01', '2024-01-31');

-- 全体統計を取得
SELECT get_analytics_summary();
```

## 🔐 セキュリティ設定

### Row Level Security (RLS)
- 記事閲覧数の挿入は全ユーザー可能
- 閲覧データの参照は認証済みユーザーのみ
- 管理者機能はクライアントサイド認証

### セッション管理
- JWTトークンベースのセッション
- ローカルストレージでの永続化
- 自動タイムアウト機能

## 🎯 使用方法

### 管理者ログイン
```
URL: /admin/login
Email: queue@queue-tech.jp
Password: Taichi00610
```

### 分析ページアクセス
1. 管理者ダッシュボードにログイン
2. 「分析」タブをクリック
3. 各種統計データを確認

### 記事閲覧数の確認
- 管理者ダッシュボード > 分析 > 記事別閲覧数
- リアルタイムで更新される閲覧数
- 人気記事ランキング表示

## 📊 分析機能の詳細

### メインステータスカード
- **今週のお問い合わせ**: 月曜日からの累計
- **今月のお問い合わせ**: 月初からの累計  
- **今月公開記事数**: 当月公開された記事数
- **総記事閲覧数**: 全記事の累計閲覧数

### 閲覧数ランキング
- 人気記事トップ10
- 閲覧数とタイトル表示
- 公開日の表示

### 推移グラフ
- 過去7日間の日別お問い合わせ数
- バー形式での視覚的表示
- 最大値に基づく相対表示

### 詳細データテーブル
- 全記事の閲覧統計
- ソート・フィルタ機能
- CSV出力対応（将来実装予定）

## 🚀 自動機能

### 記事閲覧数追跡
- **自動記録**: ユーザーが記事を50%表示した時点で記録
- **重複排除**: 同一セッションでの重複記録を防止
- **Intersection Observer**: 効率的な表示検知

### セッション管理
- **自動更新**: 5分ごとのセッション確認
- **アクティビティ検知**: マウス・キーボード操作を監視
- **自動ログアウト**: 30分無操作でタイムアウト

## 🔧 トラブルシューティング

### よくある問題

#### 1. マイグレーションエラー
```
ERROR: 42P01: relation "public.admin_users" does not exist
```
**解決方法**: 修正済みのマイグレーションファイルを使用してください。

#### 2. セッションが維持されない
- ブラウザのローカルストレージを確認
- 開発者ツールでエラーログを確認
- セッション有効期限（24時間）を確認

#### 3. 閲覧数が記録されない
- ネットワーク接続を確認
- Supabaseの接続状況を確認
- ブラウザのコンソールでエラーを確認

#### 4. 管理画面にアクセスできない
- 認証情報を確認
  - Email: `queue@queue-tech.jp`
  - Password: `Taichi00610`
- ブラウザのキャッシュをクリア

### ログの確認方法

```javascript
// ブラウザの開発者ツールで実行
// セッション状態を確認
console.log(localStorage.getItem('queue_admin_session'));

// 認証状態を確認
console.log('User authenticated:', !!useAdmin().user?.isAuthenticated);
```

## 📈 パフォーマンス最適化

### データベースインデックス
- `article_id` でのインデックス
- `created_at` でのインデックス  
- `ip_address` でのインデックス

### キャッシュ戦略
- 5分ごとのデータ更新
- ローカルストレージでのセッション保持
- 効率的なクエリ設計

## 🔄 更新履歴

### v1.3.0 (2024年2月)
- 分析機能の追加
- セッション管理の強化
- 記事閲覧数追跡の実装
- 管理者ダッシュボードの改善

### 今後の予定機能
- CSV出力機能
- より詳細な分析グラフ
- メール通知機能
- カスタムレポート作成

## 📞 サポート

問題が発生した場合は、以下の情報を含めて報告してください：

1. エラーメッセージ
2. 実行していた操作
3. ブラウザとバージョン
4. セッション状態（個人情報は除く）

---

**開発者**: Queue株式会社  
**最終更新**: 2024年2月  
**バージョン**: 1.3.0 